name: Test

on:
  pull_request:
  push:
    branches:
      - main

jobs: 
  MSVC: 
    runs-on: windows-latest
    name: MSVC Build Test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup python
        uses: actions/setup-python@v5
        with:
            python-version: '3.13'

      - name: Install build requirements
        run: python -m pip install meson ninja

      - name: Configure Build
        run: meson setup builddir -Dbuild_tests=True -Dvsenv=True

      - name: Build
        run: meson compile -C builddir

      - name: Test
        run: meson test -C builddir -vv

  Intel: 
    runs-on: windows-latest
    name: Intel-Win
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Cache Intel oneAPI BaseKit Installer
        id: cache-oneapi
        uses: actions/cache@v4
        with:
          path: basekit.exe
          key: oneapi-basekit-2025.1.3

      - name: Download Installer if Not Cached
        if: steps.cache-oneapi.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri https://registrationcenter-download.intel.com/akdlm/IRC_NAS/e5785fb3-b5a7-4b97-89bc-918adab1f77d/intel-oneapi-base-toolkit-2025.1.3.8_offline.exe -OutFile basekit.exe

      - name: Install Intel oneAPI BaseKit
        run: .\basekit.exe -a -s --eula accept -p=NEED_VS2019_INTEGRATION=0 --components intel.oneapi.win.cpp-compiler

      - name: Setup python
        uses: actions/setup-python@v5
        with:
            python-version: '3.13'

      - name: Install build requirements
        run: python -m pip install meson ninja

      - name: Check Installed directories
        run: ls 'C:\Program Files'
            

      - name: Configure Build
        run: |
            call "C:\Program Files\Intel\oneAPI\setvars-vcvarsall.bat"
            meson setup builddir -Dbuild_tests=True -Dvsenv=True
        shell: cmd
        env:
          CXX: icx

      - name: Build
        run: meson compile -C builddir

      - name: Test
        run: meson test -C builddir -vv
           
        